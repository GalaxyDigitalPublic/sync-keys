@startuml sync-db-sequence
!theme plain
skinparam linetype ortho
skinparam nodesep 150
skinparam ranksep 180

title sync-db Command Flow

actor Operator
participant "sync-db" as CLI
participant "Keystore" as KS
participant "Encoder" as Enc
participant "Web3SignerManager" as WSM
database "PostgreSQL" as DB

Operator -> CLI : sync-db --db-url --private-keys-dir
activate CLI

CLI -> DB : check_db_connection()
DB --> CLI : connection OK

CLI -> CLI : glob("keystore*.json")

loop for each keystore directory
    CLI -> Operator : prompt for password
    Operator --> CLI : password

    loop for each keystore file
        CLI -> KS : Keystore.from_file(path)
        KS --> CLI : keystore object

        CLI -> KS : decrypt(password)
        KS --> CLI : secret_bytes

        CLI -> CLI : store in keypairs dict\nwith fee_recipient
    end
end

CLI -> Operator : confirm: Found N keys, proceed?
Operator --> CLI : yes

CLI -> WSM : process_transferred_keypairs(keypairs)
activate WSM

loop for each keypair
    WSM -> Enc : encrypt(private_key)
    Enc --> WSM : encrypted_data, nonce

    WSM -> WSM : assign validator_index\n= index // capacity

    WSM -> WSM : create DatabaseKeyRecord
end

WSM --> CLI : List[DatabaseKeyRecord]
deactivate WSM

CLI -> DB : update_keys(records)
activate DB
DB -> DB : DROP TABLE IF EXISTS keys
DB -> DB : CREATE TABLE keys
DB -> DB : INSERT INTO keys
DB --> CLI : success
deactivate DB

CLI -> Operator : Output DECRYPTION_KEY
note right: Save this key securely!\nNeeded for sync-web3signer-keys

deactivate CLI

@enduml
